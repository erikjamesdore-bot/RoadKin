<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RoadKin – Adventure Traveller Rescue Network</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#c00">
  <style>
    body{font-family:system-ui,sans-serif;background:#111;color:#fff;margin:0;padding:0}
    @media(prefers-color-scheme:light){body{background:#fff;color:#000}}
    #app{max-width:480px;margin:40px auto;padding:20px}
    h1{text-align:center;color:#c00}
    input,textarea,button{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:none;font-size:16px;box-sizing:border-box}
    button{background:#c00;color:white;cursor:pointer;font-weight:bold}
    button.bigbtn{padding:30px;font-size:24px;margin:30px 0;border-radius:12px}
    .sos{background:#b00;animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,0,0,.7)}70%{box-shadow:0 0 0 30px rgba(255,0,0,0)}100%{box-shadow:0 0 0 0 rgba(255,0,0,0)}}
    .helper{background:#222;padding:15px;margin:10px 0;border-radius:10px}
    @media(prefers-color-scheme:light){.helper{background:#f0f0f0f0}}
    .hidden{display:none}
    .contact-btn{margin:4px 0;padding:10px;font-size:14px;width:auto;display:inline-block}
    .small-btn{font-size:14px;padding:10px}
  </style>
</head>
<body>
  <div id="app">
    <h1>RoadKin</h1>

    <div id="login" class="screen">
      <input type="text" id="username" placeholder="Your name or nickname" required>
      <button onclick="login()">Enter RoadKin</button>
    </div>

    <div id="main" class="screen hidden">
      <button id="install" class="bigbtn" onclick="installApp()" style="display:none">Install RoadKin (works offline)</button>
      <button class="bigbtn sos" onclick="sendSOS()">I NEED HELP NOW</button>
      <button onclick="toggleMode()">Become a Helper</button>
      <button class="small-btn" onclick="manualLocation()">Set location manually</button>
      <h2>Nearby Helpers (<span id="count">0</span>)</h2>
      <div id="helpers"></div>
    </div>

    <div id="helperMode" class="screen hidden">
      <h2>I can help riders!</h2>
      <textarea id="offer" rows="4" placeholder="What can you offer? (garage, tools, spare room, beer, languages…)"></textarea>
      <input type="text" id="contact" placeholder="Contact (WhatsApp, email, Signal…)" style="margin-top:12px">
      <label style="margin-top:12px;display:block">
        <input type="checkbox" id="availableNow" checked> Available right now
      </label>
      <button class="bigbtn" onclick="goLive()" style="margin-top:20px;background:#0a0">GO LIVE NOW</button>
      <button onclick="toggleMode()">Cancel</button>
    </div>

    <footer style="text-align:center;margin-top:50px;font-size:14px;opacity:0.7">
      Built for the road • <a href="https://roadkin.app" style="color:#c00">roadkin.app</a>
    </footer>
  </div>

  <script>
    let user = { name: "", lat: null, lon: null };
    let deferredPrompt = null;
    let helpers = [];

// PASTE YOUR NEW CLEAN CSV URL HERE (the one from your fresh Helpers tab)
    const SHEET_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-.../pub?gid=1578348969&single=true&output=csv';

    async function loadHelpers() {
      try {
        const resp = await fetch(SHEET_CSV + '&t=' + Date.now());
        if (!resp.ok) throw "";
        const text = await resp.text();
        const rows = text.split('\n').slice(1).filter(r => r.trim());
        helpers = rows.map(row => {
          const c = row.split(',').map(f => f.replace(/^"|"$/g,'').replace(/""/g,'"').trim());
          if (c.length < 6 || !c[0]) return null;
          return {
            name: c[0],
            lat: parseFloat(c[1]) || 0,
            lon: parseFloat(c[2]) || 0,
            offer: c[3] || "Can help",
            contact: c[4] || "",
            availableNow: c[5].toLowerCase() === "yes"
          };
        }).filter(Boolean);
        renderHelpers();
      } catch(e) {
        document.getElementById("helpers").innerHTML = "<i>No signal – showing last known helpers</i>";
      }
    }

    window.addEventListener('beforeinstallprompt', e=>{e.preventDefault();deferredPrompt=e;document.getElementById('install').style.display='block'});
    async function installApp(){if(deferredPrompt){deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;}}

    function login() {
      const name = document.getElementById("username").value.trim();
      if (!name) return alert("Please enter your name");
      user.name = name;
      document.getElementById("login").classList.add("hidden");
      document.getElementById("main").classList.remove("hidden");
      loadHelpers();

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(p => {
          user.lat = p.coords.latitude;
          user.lon = p.coords.longitude;
          renderHelpers();
        }, () => console.log("GPS denied"));
      }
    }

    function manualLocation() {
      const input = prompt("City / place / coordinates (or coordinates):", "Berlin");
      if (!input) return;
      if (/^-?\d/.test(input)) {
        const [lat, lon] = input.split(/[,\s]+/).map(parseFloat);
        user.lat = lat; user.lon = lon;
      } else {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input)}`)
          .then(r => r.json())
          .then(d => {
            if (d[0]) { user.lat = +d[0].lat; user.lon = +d[0].lon; renderHelpers(); }
          });
      }
      renderHelpers();
    }

    function renderHelpers() {
      const list = document.getElementById("helpers"); list.innerHTML = "";
      const nearby = helpers
        .map(h => ({...h, dist: user.lat ? haversine(user.lat,user.lon,h.lat,h.lon) : 9999}))
        .sort((a,b) => a.dist - b.dist)
        .slice(0,30);

      document.getElementById("count").textContent = nearby.length;
      nearby.forEach(h => {
        const d = document.createElement("div"); d.className="helper";
        const dist = h.dist < 9999 ? Math.round(h.dist)+" km" : "Far off-road";
        let contact = "";
        if (h.contact) {
          if (h.contact.includes('@')) contact = `<br>Contact: ${h.contact} <button class="contact-btn" onclick="location.href='mailto:${h.contact}'">Email</button>`;
          else if (/^\+?\d{8,15}$/.test(h.contact.replace(/\D/g,''))) {
            const num = h.contact.replace(/\D/g,'');
            contact = `<br>Contact: ${h.contact} <button class="contact-btn" onclick="location.href='https://wa.me/${num}'">WhatsApp</button>`;
          } else contact = `<br>Contact: ${h.contact}`;
        }
        d.innerHTML = `<strong>${h.name}</strong> – ${dist}<br>${h.offer}${contact}`;
        list.appendChild(d);
      });
    }

    function sendSOS() {
      if (!user.lat) return alert("Set your location first");
      const msg = `ROADKIN SOS – ${user.name} needs help!\nhttps://maps.google.com/?q=${user.lat},${user.lon}\n#RoadKin`;
      location.href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
    }

    function toggleMode() {
      document.getElementById("main").classList.toggle("hidden");
      document.getElementById("helperMode").classList.toggle("hidden");
      if (!document.getElementById("helperMode").classList.contains("hidden")) {
        document.getElementById("offer").focus();
      }
    }

    // THIS IS THE NEW MAGIC BUTTON
    async function goLive() {
      if (!user.name) return alert("Name missing");
      if (!user.lat) return alert("Location missing – use GPS or manual");

      const offer = document.getElementById("offer").value.trim() || "Can help";
      const contact = document.getElementById("contact").value.trim();
      const available = document.getElementById("availableNow").checked ? "Yes" : "No";

      const row = [
        user.name,
        user.lat.toFixed(6),
        user.lon.toFixed(6),
        `"${offer}"`,          // wrapped in quotes so commas never break anything
        contact,
        available
      ].join(',');

      // Append directly to your Google Sheet using the pre-publish trick (no form needed)
      const appendUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSenL5h8piDfxmqJgCUW8FiKCVUKksQla_q4Du7ICVZUVIJl6w/formResponse?' +
        'entry.2131123748=' + encodeURIComponent(user.name) +
        '&entry.1563978452=' + user.lat.toFixed(6) +
        '&entry.1612978471=' + user.lon.toFixed(6) +
        '&entry.1742973672=' + encodeURIComponent(offer) +
        '&entry.1366145812=' + available +
        (contact ? '&entry.YOUR_CONTACT_ENTRY_ID=' + encodeURIComponent(contact) : '') +
        '&usp=pp_url&submit=Submit';

      // Fire and forget – no new tab needed
      fetch(appendUrl, {method: 'POST', mode: 'no-cors'});
      
      alert("You are now LIVE worldwide! Thank you ❤️");
      toggleMode();
      setTimeout(loadHelpers, 3000);  // refresh list in 3 sec
    }

    function haversine(lat1,lon1,lat2,lon2) {
      const toRad = x => x * Math.PI / 180;
      const R = 6371;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // load on start
    window.addEventListener('load', loadHelpers);
  </script>
</body>
</html>
