<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RoadKin</title>
<style>
  body{font-family:system-ui,sans-serif;background:#111;color:#fff;margin:0;padding:0}
  @media(prefers-color-scheme:light){body{background:#fff;color:#000}}
  #app{max-width:480px;margin:40px auto;padding:20px}
  h1{text-align:center;color:#c00;margin-bottom:20px}
  .user-bar{background:#222;padding:20px;border-radius:16px;margin-bottom:20px;text-align:center;cursor:pointer}
  .user-name{font-size:24px;font-weight:700}
  .coords{font-size:14px;opacity:0.8;margin-top:8px}
  button{width:100%;padding:18px;margin:12px 0;border:none;border-radius:14px;font-size:19px;cursor:pointer;font-weight:bold}
  .bigbtn{padding:34px;font-size:26px}
  .sos{background:#b00;animation:pulse 2s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,0,0,.8)}70%{box-shadow:0 0 0 40px transparent}100%{box-shadow:0 0 0 0 transparent}}
  .go{background:#0b0}
  .helper{background:#222;padding:20px;margin:15px 0;border-radius:16px;line-height:1.6}
  .hidden{display:none}
  .contact-btn{margin-top:8px;padding:10px 16px;font-size:14px;border-radius:8px;background:#333;display:inline-block}
  label{display:block;margin:20px 0 8px;font-weight:600}
  input,textarea{width:100%;padding:16px;border-radius:12px;border:none;background:#333;color:#fff;font-size:17px;box-sizing:border-box}
</style>
</head>
<body>
<div id="app">
  <h1>RoadKin</h1>

  <div id="login">
    <input type="text" id="username" placeholder="Your name or nickname">
    <button class="bigbtn" onclick="login()">Enter RoadKin</button>
  </div>

  <div id="main" class="hidden">
    <div class="user-bar" onclick="openEdit()">
      <div class="user-name">Hi, <span id="displayName"></span></div>
      <div class="coords" id="coordsDisplay">Getting location…</div>
    </div>

    <button class="bigbtn sos" onclick="sendSOS()">I NEED HELP NOW</button>
    <button id="manualBtn" class="bigbtn" onclick="manualLocation()" style="background:#444">Set location manually</button>

    <h2>Nearby Helpers (<span id="count">0</span>)</h2>
    <div id="helpers"></div>
  </div>

  <div id="edit" class="hidden">
    <h2>What can you offer?</h2>
    <label>Your offer</label>
    <textarea id="offer" rows="5" placeholder="garage, tools, beer, spare room, welding…"></textarea>
    <label>Contact (WhatsApp, email, etc.)</label>
    <input type="text" id="contact" placeholder="+1234567890 or name@email.com">

    <button class="bigbtn go" onclick="goLive()">GO LIVE NOW</button>
    <button class="bigbtn" onclick="openEdit()" style="background:#900">Back without going live</button>
  </div>
</div>

<script>
let user = { name: "", lat: null, lon: null, offer: "", contact: "" };

const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTSwAg5Jd9Cknmj0tFKeNG76QOPbCrzttvSmHR7k2Nj6lMZRzZ6XH7yn3hdRbRB2Ss33qSpt3IFo-LO/pub?gid=1578348969&single=true&output=csv';

function saveUser() { localStorage.setItem('roadkin', JSON.stringify(user)); }
function loadUser() { 
  const s = localStorage.getItem('roadkin'); 
  if (s) { user = JSON.parse(s); return true; }
  return false;
}

async function loadHelpers() {
  try {
    const r = await fetch(CSV_URL + '&t=' + Date.now());
    const text = await r.text();
    const lines = text.split('\n').slice(1).filter(l => l.trim());
    const helpers = lines.map(l => {
      const c = l.split(',').map(x => x.trim().replace(/^"|"$/g,''));
      if (c.length < 6) return null;
      return {
        name: c[0],
        lat: +c[1],
        lon: +c[2],
        offer: c[3] || "Can help",
        contact: c[4] || "",
        available: c[5].toLowerCase() === "yes"
      };
    }).filter(Boolean);

    const online = helpers.filter(h => h.available);
    document.getElementById("count").textContent = online.length;

    const list = document.getElementById("helpers");
    list.innerHTML = "";
    if (online.length === 0) { list.innerHTML = "<i>No one online yet – be the first!</i>"; return; }

    online.forEach(h => {
      const div = document.createElement("div");
      div.className = "helper";
      const dist = user.lat ? Math.round(haversine(user.lat,user.lon,h.lat,h.lon)) + " km away" : "distance unknown";
      let contact = "";
      if (h.contact) {
        if (h.contact.includes("@")) contact = `<br>${h.contact} <button class="contact-btn" onclick="location.href='mailto:${h.contact}'">Email</button>`;
        else if (/^\+?\d{8,}$/.test(h.contact.replace(/\D/g,""))) contact = `<br>${h.contact} <button class="contact-btn" onclick="location.href='https://wa.me/${h.contact.replace(/\D/g,"")}'">WhatsApp</button>`;
        else contact = `<br>${h.contact}`;
      }
      div.innerHTML = `<strong>${h.name}</strong> – ${dist}<br>${h.offer}${contact}`;
      list.appendChild(div);
    });
  } catch(e) {
    document.getElementById("helpers").innerHTML = "<i>No internet</i>";
  }
}

function updateCoords() {
  const el = document.getElementById("coordsDisplay");
  const btn = document.getElementById("manualBtn");
  if (user.lat) {
    el.textContent = `${user.lat.toFixed(5)}, ${user.lon.toFixed(5)}`;
    btn.style.display = "none";
  } else {
    el.textContent = "Location unknown – tap here to set";
  }
}

function goLive() {
  if (!user.lat) return alert("Please wait for GPS or set location manually first");
  user.offer = document.getElementById("offer").value.trim() || "Can help";
  user.contact = document.getElementById("contact").value.trim();
  saveUser();

  const url = 'https://docs.google.com/forms/d/e/1FAIpQLSenL5h8piDfxmqJgCUW8FiKCVUKksQla_q4Du7ICVZUVIJl6w/formResponse?' +
    'entry.2131123748=' + encodeURIComponent(user.name) +
    '&entry.1563978452=' + user.lat.toFixed(6) +
    '&entry.1612978471=' + user.lon.toFixed(6) +
    '&entry.1742973672=' + encodeURIComponent(user.offer) +
    '&entry.1092196062=' + encodeURIComponent(user.contact) +
    '&entry.1366145812=yes&usp=pp_url&submit=Submit';

  fetch(url, {method: 'GET', mode: 'no-cors'});
  alert("You are now LIVE – thank you!");
  openEdit();
  setTimeout(loadHelpers, 6000);
}

function login() {
  const name = document.getElementById("username").value.trim();
  if (!name) return alert("Please enter your name");
  user.name = name;
  saveUser();
  document.getElementById("login").classList.add("hidden");
  document.getElementById("main").classList.remove("hidden");
  document.getElementById("displayName").textContent = name;
  document.getElementById("offer").value = user.offer;
  document.getElementById("contact").value = user.contact;
  updateCoords();
  loadHelpers();

  navigator.geolocation?.getCurrentPosition(pos => {
    user.lat = pos.coords.latitude;
    user.lon = pos.coords.longitude;
    saveUser();
    updateCoords();
  });
}

function openEdit() {
  document.getElementById("main").classList.toggle("hidden");
  document.getElementById("edit").classList.toggle("hidden");
}

function manualLocation() {
  const input = prompt("Enter city name or coordinates (lat,lon):");
  if (!input) return;
  const parts = input.split(/[,\s]+/).map(parseFloat);
  if (parts.length >= 2 && !isNaN(parts[0])) {
    user.lat = parts[0]; user.lon = parts[1];
  } else {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input)}`)
      .then(r => r.json()).then(data => { if (data[0]) { user.lat = +data[0].lat; user.lon = +data[0].lon; updateCoords(); }});
  }
  saveUser(); updateCoords();
}

function sendSOS() {
  if (!user.lat) return alert("Location required");
  const msg = `ROADKIN SOS – ${user.name} needs help!\nhttps://maps.google.com/?q=${user.lat},${user.lon}`;
  location.href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
}

function haversine(lat1,lon1,lat2,lon2) {
  const toRad = x => x * Math.PI / 180;
  const R = 6371;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

window.onload = () => {
  if (loadUser() && user.name) {
    document.getElementById("login").classList.add("hidden");
    document.getElementById("main").classList.remove("hidden");
    document.getElementById("displayName").textContent = user.name;
    document.getElementById("offer").value = user.offer;
    document.getElementById("contact").value = user.contact;
    updateCoords();
  }
  loadHelpers();
  setInterval(loadHelpers, 30000);
};
</script>
</body>
</html>
