<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RoadKin – Adventure Traveller Rescue Network</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#c00">
  <style>
    body{font-family:system-ui,sans-serif;background:#111;color:#fff;margin:0;padding:0;transition:background .3s,color .3s}
    @media(prefers-color-scheme:light){body{background:#fff;color:#000}}
    #app{max-width:480px;margin:40px auto;padding:20px}
    h1{text-align:center;color:#c00}
    input,textarea,button{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:none;font-size:16px;box-sizing:border-box}
    button{background:#c00;color:white;cursor:pointer;font-weight:bold}
    button.bigbtn{padding:30px;font-size:24px;margin:30px 0;border-radius:12px}
    .sos{background:#b00;animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,0,0,.7)}70%{box-shadow:0 0 0 30px rgba(255,0,0,0)}100%{box-shadow:0 0 0 0 rgba(255,0,0,0)}}
    .helper{background:#222;padding:15px;margin:10px 0;border-radius:10px}
    @media(prefers-color-scheme:light){.helper{background:#f0f0f0}}
    .hidden{display:none}
    #install{background:#222}
    @media(prefers-color-scheme:light){#install{background:#ddd;color:#000}}
    footer{text-align:center;margin-top:40px;font-size:14px;opacity:0.7}
    .kofi{color:#c00;font-weight:bold}
  </style>
</head>
<body>
  <div id="app">
    <h1>RoadKin</h1>

    <div id="login" class="screen">
      <input type="text" id="username" placeholder="Your name or nickname" required>
      <button onclick="login()">Enter RoadKin</button>
      <p style="font-size:14px;opacity:0.7;margin-top:20px">Works 100% offline after install</p>
    </div>

    <div id="main" class="screen hidden">
      <button id="install" class="bigbtn" onclick="installApp()" style="display:none">Install RoadKin (works offline)</button>
      <button class="bigbtn sos" onclick="sendSOS()">I NEED HELP NOW</button>
      <button onclick="toggleMode()">Switch to Helper Mode</button>
      <h2>Nearby Helpers (<span id="count">0</span>)</h2>
      <div id="helpers"></div>
    </div>

    <div id="helperMode" class="screen hidden">
      <h2>I Can Help!</h2>
      <textarea id="offer" placeholder="e.g. garage, welder, spare room, speaks Spanish, cold beer..."></textarea><br>
      <label><input type="checkbox" id="availableNow" checked> Available right now</label><br>
      <button onclick="saveHelperProfile()">Save My Profile</button>
      <button onclick="toggleMode()">Back to Rider Mode</button>
    </div>

    <footer>
      Built for the road less traveled • <a href="https://roadkin.app" style="color:#c00">roadkin.app</a>
      <br><br>
      ❤️ Love RoadKin? <a href="https://ko-fi.com/roadkin" class="kofi" target="_blank">Buy me a beer</a>
    </footer>
  </div>

  <script>
    let user = null;
    let deferredPrompt = null;
    let helpers = [];

    // === YOUR GOOGLE SHEET (published as CSV) ===
    const SHEET_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT5d8gJ9vJ8zL7kN5vR8P9mKxL3qWvB9jH2fG5sR8tL9pQvM3nX7cYbD2fG8hJ9kL3nP5qR7tU9vW1xY/pub?output=csv';

    async function loadHelpers() {
      try {
        const resp = await fetch(SHEET_CSV + '&t=' + Date.now());
        const text = await resp.text();
        const rows = text.split('\n').slice(1);
        helpers = rows.map(row => {
          const cols = row.split(',').map(s => s.replace(/^"|"$/g, '').trim());
          if (cols.length < 5) return null;
          return {
            name: cols[0] || "Anonymous rider",
            lat: parseFloat(cols[1]) || 0,
            lon: parseFloat(cols[2]) || 0,
            offer: cols[3] || "Can help somehow",
            availableNow: cols[4] === "Yes"
          };
        }).filter(h => h && h.availableNow);
        renderHelpers();
      } catch(e) {
        alert("No signal – using last known helpers");
      }
    }

    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('install').style.display = 'block';
    });
    async function installApp() {
      if (!deferredPrompt) return alert('Already installed');
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') deferredPrompt = null;
    }
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(() => {});

    function login() {
      const name = document.getElementById("username").value.trim();
      if (!name) return alert("Enter your name");
      user = { name, lat: null, lon: null };
      document.getElementById("login").classList.add("hidden");
      document.getElementById("main").classList.remove("hidden");
      loadHelpers();
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          user.lat = pos.coords.latitude;
          user.lon = pos.coords.longitude;
          renderHelpers();
        }, () => {});
      }
    }

    function renderHelpers() {
      const list = document.getElementById("helpers");
      list.innerHTML = "";
      const nearby = helpers
        .map(h => ({...h, dist: user?.lat ? haversine(user.lat, user.lon, h.lat, h.lon) : 999}))
        .sort((a,b) => a.dist - b.dist)
        .slice(0,20);
      document.getElementById("count").textContent = nearby.length;
      nearby.forEach(h => {
        const div = document.createElement("div");
        div.className = "helper";
        div.innerHTML = `
          <strong>${h.name}</strong> – ${h.dist < 999 ? Math.round(h.dist)+" km away" : "Far off-road"}<br>
          ${h.offer}<br>
          <button onclick="callHelper()">Call / WhatsApp</button>
        `;
        list.appendChild(div);
      });
    }

    function sendSOS() {
      if (!user?.lat) return alert("Waiting for GPS… step outside or allow location.");
      const msg = `ROADKIN SOS\n${user.name} needs urgent help!\nLocation: https://maps.google.com/?q=${user.lat},${user.lon}\nDetails: (add your problem here)\n#RoadKin`;
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
      alert("SOS ready – share it!");
    }

    function toggleMode() {
      document.getElementById("main").classList.toggle("hidden");
      document.getElementById("helperMode").classList.toggle("hidden");
    }

    function saveHelperProfile() {
      if (!user) return alert("Log in first!");
      const offer = document.getElementById("offer").value || "Can help somehow";
      const available = document.getElementById("availableNow").checked ? "Yes" : "No";
      const lat = user.lat || "";
      const lon = user.lon || "";

      const formUrl = 'https://docs.google.com/forms/d/e/1GzgYFYF4gtFEPz3jEvwKJDRGXw_BOsKoD_e0mHCxC0w/formResponse?usp=pp_url' +
        '&entry.2131123748=' + encodeURIComponent(user.name) +
        '&entry.1563978452=' + lat +
        '&entry.1612978471=' + lon +
        '&entry.1742973672=' + encodeURIComponent(offer) +
        '&entry.1366145812=' + available;

      window.open(formUrl, '_blank');
      alert("Form opened and pre-filled!\nJust tap SUBMIT and you’re live for everyone in seconds!");
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const toRad = x => x * Math.PI / 180;
      const R = 6371;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function callHelper() {
      alert("No phone listed – use WhatsApp SOS and mention them!");
    }
  </script>
</body>
</html>
